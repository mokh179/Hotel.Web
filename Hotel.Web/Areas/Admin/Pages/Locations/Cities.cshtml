@page
@model Hotel.Web.Areas.Admin.Pages.Locations.CitiesModel
@{
    ViewData["Title"] = "Cities";
}

<link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
<link href="~/css/admin/locations/cities.css" rel="stylesheet" asp-append-version="true" />

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Cities</h2>

    <button class="btn btn-success" id="btnAdd" data-bs-toggle="modal" data-bs-target="#cityModal">
        Add City
    </button>
</div>

<div class="mb-3 d-flex" style="max-width: 350px;">
    <select class="form-select" onchange="location.href='?CountryId=' + this.value">
        <option value="">All Countries</option>
        @foreach (var c in Model.Countries)
        {
            <option value="@c.Id" selected="@(Model.CountryId == c.Id ? "selected" : null)">
    @c.Name
</option>
        }
    </select>
</div>

<table class="table table-bordered table-striped">
    <thead class="table-dark">
        <tr>
            <th>City</th>
            <th>Country</th>
            <th style="width: 150px;">Actions</th>
        </tr>
    </thead>
    <tbody id="citiesList">
        @foreach (var city in Model.Cities)
        {
            <tr id="city_@city.Id">
                <td>@city.Name</td>
                <td>@city.CountryName</td>
                <td>
                    <button class="btn btn-warning btn-sm btn-edit" data-id="@city.Id">Edit</button>
                    <button class="btn btn-danger btn-sm btn-delete" data-id="@city.Id">Delete</button>
                </td>
            </tr>
        }
    </tbody>
</table>

<!-- Modal -->
<div class="modal fade" id="cityModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="cityForm">
                @Html.AntiForgeryToken()

                <div class="modal-header">
                    <h5 class="modal-title" id="cityModalLabel">Add City</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <input type="hidden" id="Input_Id" name="Id" />

                    <div class="mb-3">
                        <label class="form-label">City Name</label>
                        <input id="Input_Name" name="Name" class="form-control" required />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Country</label>
                        <select id="Input_CountryId" name="CountryId" class="form-select country-select" required>
                            <option value=""></option>
                            @foreach (var c in Model.Countries)
                            {
                                <option value="@c.Id">@c.Name</option>
                            }
                        </select>
                    </div>

                    <div id="modalErrors" class="text-danger"></div>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button id="modalSave" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Scripts: jQuery first, then select2, then bootstrap bundle -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // helper: read antiforgery token rendered by @Html.AntiForgeryToken()
    function getAntiForgeryToken() {
        const el = document.querySelector('input[name="__RequestVerificationToken"]');
        return el ? el.value : null;
    }

    // initialize select2 inside modal (called when modal shown)
    function initSelect2InModal() {
        $('.country-select').select2({
            dropdownParent: $('#cityModal'),
            width: '100%',
            placeholder: 'Choose country',
            allowClear: true
        });
    }

    // basic fetch helper
    async function getJson(url) {
        const r = await fetch(url, { credentials: 'same-origin' });
        return await r.json();
    }

    // render row (expects server returns { id, name, countryName } or PascalCase)
    function normalizeVal(o, key) {
        return o[key] ?? o[key.charAt(0).toUpperCase() + key.slice(1)] ?? o[key.charAt(0).toLowerCase() + key.slice(1)];
    }

    function rowTemplate(c) {
        const id = normalizeVal(c, 'id');
        const name = normalizeVal(c, 'name') || '';
        const countryName = normalizeVal(c, 'countryName') || '';
        return `
            <tr id="city_${id}">
                <td>${name}</td>
                <td>${countryName}</td>
                <td>
                    <button class="btn btn-warning btn-sm btn-edit" data-id="${id}">Edit</button>
                    <button class="btn btn-danger btn-sm btn-delete" data-id="${id}">Delete</button>
                </td>
            </tr>`;
    }

    function addRow(c) {
        document.getElementById('citiesList').insertAdjacentHTML('afterbegin', rowTemplate(c));
        bindEvents();
    }

    function updateRow(c) {
        const id = normalizeVal(c, 'id');
        const row = document.getElementById('city_' + id);
        if (row) row.outerHTML = rowTemplate(c);
        bindEvents();
    }

    function removeRow(id) {
        document.getElementById('city_' + id)?.remove();
    }

    // bind edit/delete buttons (call after DOM changes)
    function bindEvents() {
        // edit
        document.querySelectorAll('.btn-edit').forEach(btn => {
            btn.onclick = async () => {
                const id = btn.dataset.id;
                const c = await getJson(`?handler=City&id=${id}`);

                document.getElementById('Input_Id').value = normalizeVal(c, 'id');
                document.getElementById('Input_Name').value = normalizeVal(c, 'name');

                // set select2 value (ensure select2 exists)
                $('#Input_CountryId').val(normalizeVal(c, 'countryId')).trigger('change');

                document.getElementById('modalErrors').innerHTML = '';
                document.getElementById('cityModalLabel').innerText = 'Edit City';

                // show modal (select2 already initialized on shown)
                new bootstrap.Modal(document.getElementById('cityModal')).show();
            };
        });

        // delete
        document.querySelectorAll('.btn-delete').forEach(btn => {
            btn.onclick = async () => {
                const id = btn.dataset.id;
                if (!confirm('Are you sure you want to delete this city?')) return;

                const fd = new FormData();
                fd.append('id', id);

                const token = getAntiForgeryToken();
                if (token) fd.append('__RequestVerificationToken', token);

                const res = await fetch(`?handler=DeleteAjax`, {
                    method: 'POST',
                    body: fd,
                    credentials: 'same-origin'
                });

                let data = null;
                try { data = await res.json(); } catch (e) { console.error('Delete: invalid JSON', e); }

                if (res.ok && data && data.success) {
                    removeRow(id);
                } else {
                    alert('Delete failed');
                    console.error('Delete error', res.status, data);
                }
            };
        });
    }

    bindEvents();

    // when modal opens initialize select2 (ensures dropdown works inside modal)
    const cityModalEl = document.getElementById('cityModal');
    cityModalEl.addEventListener('shown.bs.modal', () => {
        initSelect2InModal();
    });

    // Add button behavior
    document.getElementById('btnAdd').onclick = () => {
        document.getElementById('cityForm').reset();
        document.getElementById('Input_Id').value = '';
        document.getElementById('modalErrors').innerHTML = '';
        document.getElementById('cityModalLabel').innerText = 'Add City';
        // clear select2 value
        $('#Input_CountryId').val(null).trigger('change');
    };

    // submit create/edit
    document.getElementById('cityForm').addEventListener('submit', async e => {
        e.preventDefault();

        const id = document.getElementById('Input_Id').value;
        const fd = new FormData(e.target);

        // ensure antiforgery token
        const token = getAntiForgeryToken();
        if (token && !fd.has('__RequestVerificationToken')) fd.append('__RequestVerificationToken', token);

        const handler = id ? 'EditAjax' : 'CreateAjax';

        const res = await fetch(`?handler=${handler}`, {
            method: 'POST',
            body: fd,
            credentials: 'same-origin'
        });

        let data = null;
        try { data = await res.json(); } catch (err) {
            document.getElementById('modalErrors').innerText = 'Invalid server response';
            console.error('submit parse', err);
            return;
        }

        if (!data.success) {
            document.getElementById('modalErrors').innerHTML = (data.errors || ['Server error']).join('<br>');
            return;
        }

        const city = data.city;

        if (id) updateRow(city);
        else addRow(city);

        // hide modal and remove leftover backdrop
        bootstrap.Modal.getInstance(cityModalEl).hide();
        document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
    });

    // cleanup backdrop leftovers
    document.addEventListener('hidden.bs.modal', () => {
        document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
    });
</script>
