@page
@model Hotel.Web.Areas.Admin.Pages.Locations.CitiesModel
@{
    ViewData["Title"] = "Cities";
}

<link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
<link href="~/css/admin/locations/cities.css" asp-append-version="true" rel="stylesheet" />

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Cities</h2>

    <button class="btn btn-success" id="btnAdd" data-bs-toggle="modal" data-bs-target="#cityModal">
        Add City
    </button>
</div>

<div class="mb-3 d-flex" style="max-width: 400px;">
    <select class="form-select" onchange="location.href='?CountryId=' + this.value">
        <option value="">All Countries</option>
        @foreach (var c in Model.Countries)
        {
            <option value="@c.Id" selected="@(Model.CountryId == c.Id)">
                @c.Name
            </option>
        }
    </select>
</div>

<table class="table table-bordered table-striped">
    <thead class="table-dark">
        <tr>
            <th>City</th>
            <th>Country</th>
            <th style="width: 180px;">Actions</th>
        </tr>
    </thead>
    <tbody id="citiesList">
        @foreach (var city in Model.Cities)
        {
            <tr id="city_@city.Id">
                <td>@city.Name</td>
                <td>@city.CountryName</td>
                <td>
                    <button class="btn btn-warning btn-sm btn-edit" data-id="@city.Id">Edit</button>
                    <button class="btn btn-danger btn-sm btn-delete" data-id="@city.Id">Delete</button>
                </td>
            </tr>
        }
    </tbody>
</table>

<!-- Modal -->
<div class="modal fade" id="cityModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="cityForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="cityModalLabel">Add City</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">

                    <input type="hidden" id="Input_Id" name="Id" />

                    <div class="mb-3">
                        <label class="form-label">City Name</label>
                        <input id="Input_Name" name="Name" class="form-control" required />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Country</label>
                        <select id="Input_CountryId" name="CountryId" class="form-select" required>
                            <option value="">Choose country</option>
                            @foreach (var c in Model.Countries)
                            {
                                <option value="@c.Id">@c.Name</option>
                            }
                        </select>
                    </div>

                    <div id="modalErrors" class="text-danger"></div>

                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button id="modalSave" class="btn btn-primary">Save</button>
                </div>

            </form>
        </div>
    </div>
</div>


<script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>

<script>

    async function getJson(url) {
        const res = await fetch(url);
        return await res.json();
    }

    function cityRow(c) {
        return `
            <tr id="city_${c.id}">
                <td>${c.name}</td>
                <td>${c.countryName}</td>
                <td>
                    <button class="btn btn-warning btn-sm btn-edit" data-id="${c.id}">Edit</button>
                    <button class="btn btn-danger btn-sm btn-delete" data-id="${c.id}">Delete</button>
                </td>
            </tr>
        `;
    }

    function addCity(c) {
        document.getElementById("citiesList")
            .insertAdjacentHTML("afterbegin", cityRow(c));
        bindEvents();
    }

    function updateCity(c) {
        const row = document.getElementById("city_" + c.id);
        if (row) row.outerHTML = cityRow(c);
        bindEvents();
    }

    function deleteCity(id) {
        document.getElementById("city_" + id)?.remove();
    }

    function bindEvents() {

        document.querySelectorAll(".btn-edit").forEach(btn => {
            btn.onclick = async () => {
                const id = btn.dataset.id;
                const c = await getJson(`?handler=City&id=${id}`);

                document.getElementById("Input_Id").value = c.id;
                document.getElementById("Input_Name").value = c.name;
                document.getElementById("Input_CountryId").value = c.countryId;

                document.getElementById("modalErrors").innerHTML = "";
                document.getElementById("cityModalLabel").innerText = "Edit City";

                new bootstrap.Modal(document.getElementById("cityModal")).show();
            };
        });

        document.querySelectorAll(".btn-delete").forEach(btn => {
            btn.onclick = async () => {
                if (!confirm("Are you sure you want to delete this city?")) return;

                const id = btn.dataset.id;
                const res = await fetch(`?handler=DeleteAjax&id=${id}`, { method: "POST" });
                const data = await res.json();

                if (data.success) deleteCity(id);
                else alert("Delete failed");
            };
        });
    }

    bindEvents();

    // When clicking ADD
    document.getElementById("btnAdd").onclick = () => {
        document.getElementById("cityForm").reset();
        document.getElementById("Input_Id").value = "";
        document.getElementById("modalErrors").innerHTML = "";
        document.getElementById("cityModalLabel").innerText = "Add City";
    };

    // Submit Form (Create / Edit)
    document.getElementById("cityForm").addEventListener("submit", async e => {
        e.preventDefault();

        const id = document.getElementById("Input_Id").value;
        const form = new FormData(e.target);

        const handler = id ? "EditAjax" : "CreateAjax";

        const res = await fetch(`?handler=${handler}`, {
            method: "POST",
            body: form
        });

        const data = await res.json();

        if (!data.success) {
            document.getElementById("modalErrors").innerHTML =
                (data.errors || ["Server error"]).join("<br>");
            return;
        }

        const city = data.city;

        if (id)
            updateCity(city);
        else
            addCity(city);

        bootstrap.Modal.getInstance(document.getElementById("cityModal")).hide();
    });

</script>
