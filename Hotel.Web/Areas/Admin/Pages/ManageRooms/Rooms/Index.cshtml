@page
@model Hotel.Web.Areas.Admin.Pages.ManageRooms.Rooms.IndexModel
@{
    ViewData["Title"] = "Rooms";
}

<link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Rooms</h2>

    <button class="btn btn-success" id="btnAdd">Add Room</button>
</div>

<!-- Filters -->
<div class="card p-3 mb-3">
    <div class="row g-2">

        <div class="col-md-2">
            <input type="text" id="numberFilter" class="form-control" placeholder="Room number">
        </div>

        <div class="col-md-3">
            <select id="hotelFilter" class="form-select">
                <option value="">All Hotels</option>
                @foreach (var h in Model.Hotels)
                {
                    <option value="@h.Id">@h.Name</option>
                }
            </select>
        </div>

        <div class="col-md-3">
            <select id="roomTypeFilter" class="form-select">
                <option value="">All Types</option>
                @foreach (var rt in Model.RoomTypes)
                {
                    <option value="@rt.Id">@rt.Name</option>
                }
            </select>
        </div>

        <div class="col-md-2">
            <select id="availabilityFilter" class="form-select">
                <option value="">Any Status</option>
                <option value="available">Available</option>
                <option value="booked">Booked</option>
            </select>
        </div>

        <div class="col-md-2 d-grid">
            <button id="btnSearch" class="btn btn-primary">Search</button>
        </div>
    </div>
</div>

<!-- Rooms list -->
<div class="row" id="roomsList"></div>

<nav>
    <ul class="pagination" id="pager"></ul>
</nav>

<!-- Modal Container -->
<div class="modal fade" id="roomModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" id="roomModalContent"></div>
    </div>
</div>

<script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const modalEl = document.getElementById("roomModal");

    // Load partials
    async function loadPartial(url) {
        const res = await fetch(url);
        const html = await res.text();
        document.getElementById("roomModalContent").innerHTML = html;
        new bootstrap.Modal(modalEl).show();
        bindModalForm();
    }

    // Create
    document.getElementById("btnAdd").onclick = () =>
        loadPartial("?handler=CreatePartial");

    // Search + Load Rooms
    async function loadRooms(page = 1) {
        const number = numberFilter.value;
        const hotelId = hotelFilter.value;
        const roomTypeId = roomTypeFilter.value;
        const availability = availabilityFilter.value;

        const res = await fetch(`?handler=SearchAjax&number=${number}&hotelId=${hotelId}&roomTypeId=${roomTypeId}&availability=${availability}&page=${page}`);
        const json = await res.json();

        const list = document.getElementById("roomsList");
        list.innerHTML = "";

        json.items.forEach(r => {
            list.insertAdjacentHTML("beforeend", createCard(r));
        });

        renderPager(json.totalPages, json.page);
        attachCardEvents();
    }

    function createCard(r) {
        return `
        <div class="col-md-4 mb-3" id="room_${r.id}">
            <div class="card p-2">
                <h5>Room ${r.roomNumber}</h5>
                <p>${r.hotelName} - ${r.roomTypeName}</p>
                <p><strong>Price:</strong> ${r.price}</p>
                <p><strong>Status:</strong> ${r.isAvailable ? "Available" : "Booked"}</p>

                <button class="btn btn-info btn-sm btn-details" data-id="${r.id}">Details</button>
                <button class="btn btn-warning btn-sm btn-edit" data-id="${r.id}">Edit</button>
                <button class="btn btn-danger btn-sm btn-delete" data-id="${r.id}">Delete</button>
            </div>
        </div>`;
    }

    function renderPager(totalPages, current) {
        const pager = document.getElementById("pager");
        pager.innerHTML = "";

        for (let i = 1; i <= totalPages; i++) {
            pager.insertAdjacentHTML("beforeend",
                `<li class="page-item ${i === current ? "active" : ""}">
                    <a class="page-link" href="#" data-p="${i}">${i}</a>
                </li>`);
        }

        pager.querySelectorAll("a").forEach(a => {
            a.onclick = (e) => {
                e.preventDefault();
                loadRooms(a.dataset.p);
            }
        });
    }

    // Attach action buttons
    function attachCardEvents() {
        document.querySelectorAll(".btn-edit").forEach(btn => {
            btn.onclick = () =>
                loadPartial(`?handler=EditPartial&id=${btn.dataset.id}`);
        });

        document.querySelectorAll(".btn-details").forEach(btn => {
            btn.onclick = () =>
                loadPartial(`?handler=DetailsPartial&id=${btn.dataset.id}`);
        });

        document.querySelectorAll(".btn-delete").forEach(btn => {
            btn.onclick = async () => {
                if (!confirm("Delete room?")) return;

                const fd = new FormData();
                fd.append("id", btn.dataset.id);
                const res = await fetch("?handler=DeleteAjax", { method: "POST", body: fd });
                const json = await res.json();

                if (json.success)
                    document.getElementById(`room_${btn.dataset.id}`).remove();
            };
        });
    }

    // Modal Form Submit
    function bindModalForm() {
        const form = document.querySelector("#roomModalContent form");
        if (!form) return;

        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            const fd = new FormData(form);
            const handler = form.dataset.handler;

            const res = await fetch(`?handler=${handler}`, {
                method: "POST",
                body: fd
            });

            const json = await res.json();

            if (!json.success) {
                form.querySelector(".modal-errors").innerHTML =
                    json.errors.join("<br>");
                return;
            }

            bootstrap.Modal.getInstance(modalEl).hide();
            loadRooms();
        });
    }

    document.getElementById("btnSearch").onclick = () => loadRooms(1);

    loadRooms();
</script>
